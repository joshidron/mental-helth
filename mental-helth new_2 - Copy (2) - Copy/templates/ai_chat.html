{% extends 'base.html' %}

{% block content %}
<div class="card" style="max-width: 800px; margin: 0 auto;">
    <h2 style="text-align: center; color: var(--peacock-teal);">AI Mental Health Assistant</h2>
    <p style="text-align: center; color: #666;">Chat with our AI to assess your mental well-being based on our
        comprehensive knowledge base.</p>

    <div id="chat-box"
        style="height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 10px; background: #fffbe6; margin-bottom: 20px;">
        <div class="message ai-message">
            <strong>Assistant:</strong> Namaste! I am your Prajna Path assistant. Please describe how you are feeling
            today, or mention any symptoms you are experiencing.
        </div>
    </div>

    <div class="input-area" style="display: flex; gap: 10px;">
        <input type="text" id="user-input" placeholder="Type your response here..."
            style="flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
        <button onclick="sendMessage()" class="btn" style="padding: 10px 20px;">Send</button>
    </div>

    <div style="text-align: center; margin-top: 20px;">
        <form action="{{ url_for('generate_ai_report_route') }}" method="POST" id="report-form">
            <input type="hidden" name="chat_history" id="chat-history-input">
            <button type="button" onclick="submitReport()" class="btn" style="background-color: #2196F3;">Generate
                Report Based on Chat</button>
        </form>
    </div>
</div>

<style>
    .message {
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 8px;
        max-width: 80%;
    }

    .user-message {
        background-color: #e3f2fd;
        margin-left: auto;
        text-align: right;
    }

    .ai-message {
        background-color: #f1f8e9;
        margin-right: auto;
        text-align: left;
    }

    .btn {
        background: linear-gradient(135deg, #0d5c63 0%, #15757d 100%);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .btn:hover {
        transform: translateY(-2px);
    }
</style>

<script>
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');

    userInput.addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
            sendMessage();
        }
    });

    function appendMessage(sender, text, isUser) {
        const div = document.createElement('div');
        div.className = 'message ' + (isUser ? 'user-message' : 'ai-message');
        div.innerHTML = `<strong>${sender}:</strong> ${text}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        appendMessage('You', text, true);
        userInput.value = '';

        // Call backend API
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });
            const data = await response.json();
            if (data.error) {
                appendMessage('Error', data.error, false);
            } else {
                appendMessage('Assistant', data.response, false);
            }
        } catch (e) {
            appendMessage('Error', 'Failed to reach server.', false);
        }
    }

    function submitReport() {
        // Collect chat logic if needed, or just let the backend handle the last session context
        // For simplicity, we submit the chat history text
        const history = chatBox.innerText;
        document.getElementById('chat-history-input').value = history;
        document.getElementById('report-form').submit();
    }
</script>
{% endblock %}